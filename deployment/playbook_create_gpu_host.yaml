# This Playbook initializes the Ansible Controller VM as per the guide at
# https://learn.microsoft.com/en-us/azure/developer/ansible/install-on-linux-vm?source=recommendations&tabs=azure-cli#prerequisites
#
# Notes:
# - The should be run on the control node (eg on the developer's machine, or a seperate VM).
# - It does not require an Ansible hosts inventory file as it targets localhost only.
# - The developer must have the Azure CLI installed and be logged in.
#
# Once complete, the Ansible Controller VM should be ready to use for further deployment tasks.
#
# Ensure that the Ansible Azure Collection is installed:
# ansible-galaxy collection install azure.azcollection
# After this, it may be necessary to install some dependencies using pip.
# from somewhere like .venv/lib/python3.11/site-packages/ansible_collections/azure/azcollection/requirements.txt
#
# See this comment if there are problems with the `az` CLI
# https://github.com/Azure/azure-cli/issues/31419#issuecomment-2858720156

- import_playbook: playbook_create_static_resources.yaml

- name: Initialize GPU Host VM
  hosts: localhost
  gather_facts: false
  connection: local
  vars_files:
  - vars_common.yaml
  tasks:
  - name: Create resource group
    azure_rm_resourcegroup:
      name: "{{ gpu_resource_group }}"
      location: "{{ location }}"

  - name: debug cloud_init_users.yaml
    debug:
      msg: "{{ lookup('file', 'cloud_init_users.yaml') }}"

  - name: Create VM
    azure_rm_virtualmachine:
      resource_group: "{{ gpu_resource_group }}"
      name: "{{ vm_name }}"
      vm_size: "{{ vm_size }}"
      admin_username: "{{ ansible_user_id }}"
      ssh_password_enabled: false
      ssh_public_keys:
        - path: "/home/{{ ansible_user_id }}/.ssh/authorized_keys"
          key_data: "{{ lookup('file', ssh_key_file + '.pub') }}"
      custom_data: "{{ lookup('file', 'cloud_init_users.yaml') }}"
      # data_disks:
      #   - lun: 0
      os_disk_size_gb: 512
      managed_disk_type: Premium_LRS
      network_interfaces: 
        - resource_group: "{{ static_resource_group }}"
          name: "{{ nic_name }}"
      started: true
      state: present
      # # Standard Ubuntu 22.04 LTS image
      # image:
      #   offer: 0001-com-ubuntu-server-jammy
      #   publisher: Canonical
      #   sku: 22_04-lts-gen2
      #   version: latest
      # # No plan required for standard Ubuntu image
      
      # NVIDIA GPU Optimized VM Image - A10
      # as per https://azuremarketplace.microsoft.com/en-us/marketplace/apps/nvidia
      # image:
      #   publisher: nvidia
      #   offer: nvidia-gpu-optimized-vmi-a10
      #   sku: nvidia_base_a10_vmi_22_08_gen2
      #   version: latest
      # plan:
      #   name: nvidia_base_a10_vmi_22_08_gen2
      #   publisher: nvidia
      #   product: nvidia-gpu-optimized-vmi-a10
      # accept_terms: true

      # NVIDIA GPU Optimized VM Image (without "with vGPU driver" in the name)
      image: 
        publisher: nvidia
        offer: ngc_azure_17_11
        sku: ngc-base-version-25_9_1_gen2
        version: latest
      plan: 
        name: ngc-base-version-25_9_1_gen2
        publisher: nvidia
        product: ngc_azure_17_11
    register: vm_creation

  # If creating the VM succeeds, update the known_keys
  - block:
    - name: Retrieve and extract public IP address
      azure_rm_publicipaddress_info:
        resource_group: "{{ static_resource_group }}"
        name: "{{ public_ip_name }}"
      register: gpu_vm_public_ip_info

    - name: Set GPU VM public IP variable
      set_fact:
        gpu_vm_public_ip: "{{ gpu_vm_public_ip_info.publicipaddresses[0].ip_address }}"

    - name: Wait for SSH to become available on GPU VM
      ansible.builtin.wait_for:
        host: "{{ gpu_vm_public_ip }}"
        port: 22
        delay: 10
        timeout: 300
        state: started

    - name: Remove old known_hosts entry for GPU VM IP
      ansible.builtin.known_hosts:
        name: "{{ gpu_vm_public_ip }}"
        state: absent

    - name: Add to new key to known_hosts for GPU VM IP
      ansible.builtin.known_hosts:
        name: "{{ gpu_vm_public_ip }}"
        # `-T 60` sets a timeout of 60 seconds, which allows for the new VM to finish booting up.
        key: "{{ lookup('pipe', 'ssh-keyscan -T 60 -H ' + gpu_vm_public_ip) }}"

    # The nvidia_base_a10_vmi_22_08_gen2 image seems to need a reboot immediately after creation
    - name: Reboot GPU VM to complete setup
      azure_rm_virtualmachine:
        resource_group: "{{ gpu_resource_group }}"
        name: "{{ vm_name }}"
        restarted: true

    - name: Wait for SSH to become available on GPU VM
      ansible.builtin.wait_for:
        host: "{{ gpu_vm_public_ip }}"
        port: 22
        delay: 10
        timeout: 300
        state: started

    # End of VM creation block
    when: vm_creation.changed
